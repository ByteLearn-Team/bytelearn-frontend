<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BytLearn — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* Theme colors for consistent design throughout the page */
    :root { 
      --border: rgba(255,255,255,0.2);
      --glass: rgba(255,255,255,0.1);
      --text: #fff;
      --muted: rgba(255,255,255,0.8);
    }

    /* Reset default browser spacing and use border-box for easier sizing */
    * { box-sizing: border-box; } 

    /* Base page setup */
    html, body { 
      height: 100%;
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; 
      color: var(--text);
    }

    /* Main background gradient from purple to pink to blue */
    body {
      background: linear-gradient(135deg, #7e22ce 0%, #f472b6 45%, #6366f1 100%);
      background-attachment: fixed;
      position: relative;
      overflow-x: hidden;
      font-size: 18px;
      text-align: center;
    }

    /* Dark overlay to improve text readability */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      pointer-events: none;
      z-index: 0;
    }

    .overlay { 
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
    }

    /* Main container that centers content and limits width */
    .container { 
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px;
      text-align: center;
    }

    main.container { 
      min-height: calc(100vh - 120px);
    }

    /* Flexbox row for horizontal layouts */
    .row { 
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      text-align: center;
    }

    /* Logo section styling */
    .logo { 
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo img { 
      width: 70px;
      height: 70px;
    }

    /* Reusable button with glass effect */
    .btn { 
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.12);
      color: #fff;
      text-decoration: none;
      transition: 150ms;
      backdrop-filter: blur(6px);
    }

    .btn:hover { 
      background: rgba(255,255,255,0.2);
    }

    /* Glass morphism card component */
    .card { 
      background: rgba(255,255,255,0.105);
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 18px;
      padding: 24px;
      backdrop-filter: blur(8px);
      text-align: center;
    }

    h2 { 
      font-size: 28px;
      font-weight: 800;
      margin: 0 0 16px;
      text-align: center;
    }

    /* Grid layout for panels - starts as single column on mobile */
    .grid { 
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    /* Desktop view: three equal columns */
    @media(min-width:1024px){ 
      .grid { 
        grid-template-columns: repeat(3, minmax(0, 1fr));
        min-height: 520px;
      } 
    }

    .item { 
      margin-bottom: 10px;
    }

    /* Clickable items for class, subject, and chapter selection */
    .item a { 
      display: block;
      width: 100%;
      text-decoration: none;
      color: #fff;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 18px;
      transition: 150ms;
      text-align: center;
      font-size: 18px;
    }

    .item a:hover { 
      background: rgba(255,255,255,0.14);
    }

    /* Progress indicator showing current step */
    .progress { 
      margin: 0 0 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Pill-shaped badges for progress steps */
    .badge { 
      display: inline-flex;
      align-items: center;
      padding: 8px 14px;
      background: rgba(255,255,255,0.14);
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 14px;
    }

    /* Highlight animation when a new panel becomes active */
    .highlight { 
      animation: dashHighlight 900ms ease-out;
    }

    @keyframes dashHighlight {
      0% { 
        box-shadow: 0 0 0 0 rgba(255,255,255,0.5);
      }
      100% { 
        box-shadow: 0 0 0 16px rgba(255,255,255,0);
      }
    }

    .hidden { 
      display: none !important;
    }

    /* Smooth transitions for panel movement */
    .panel { 
      transition: transform 500ms ease, opacity 500ms ease;
    }

    /* Panel positioning states for the three-panel flow */
    .panel.center { 
      transform: translateX(0) scale(1);
      opacity: 1;
    }

    .panel.left { 
      transform: translateX(0) scale(.99);
      opacity: .96;
    }

    .panel.far-left { 
      transform: translateX(0) scale(.985);
      opacity: .94;
    }

    .panel.right { 
      transform: translateX(16px) scale(.99);
      opacity: .96;
    }

    /* Desktop: three panels side-by-side */
    @media(min-width:1024px){
      .stage { 
        display: flex;
        align-items: stretch;
        justify-content: center;
        gap: 16px;
        min-height: 600px;
      }
      .stage .card { 
        width: 100%;
        max-width: 384px;
      }
      .stage { 
        margin-top: 0 !important;
      }
    }

    .stage { 
      min-height: 60vh;
    }

    @media(min-width:1024px){ 
      .stage { 
        min-height: 640px;
      } 
    }

    .stage {
      margin-top: 0 !important;
    }

    #panel-chapter { 
      display: flex;
      flex-direction: column;
    }

    #panel-chapter h2 { 
      margin-bottom: 12px;
    }

    /* Scrollable chapter list with custom scrollbar */
    #chapters-list {
      overflow: auto;
      max-height: min(70vh, 640px);
      padding-right: 8px;
      margin-top: 4px;
      scroll-behavior: smooth;
    }

    #chapters-list::-webkit-scrollbar { 
      width: 10px;
    }

    #chapters-list::-webkit-scrollbar-thumb { 
      background: rgba(255,255,255,0.35);
      border-radius: 8px;
    }

    #chapters-list::-webkit-scrollbar-track { 
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
    }

    @media(min-width:1024px){
      #progress-pill {
        position: static;
        left: auto;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto 8px;
      }
    }

    /* Progress indicator with gradient background */
    #progress-pill {
      background: linear-gradient(135deg, rgba(255, 192, 203, 0.20), rgba(255, 255, 255, 0.10));
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 16px;
      padding: 18px 22px;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 8px;
    }

    .badge {
      font-size: 14px;
      padding: 8px 14px;
    }

    @media(min-width:1024px){
      .stage {
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
      }
    }

    #progress-pill {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 8px;
    }

    @media(min-width:1024px){
      #progress-pill,
      .stage {
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
      }

      #progress-pill {
        position: static;
        left: auto;
        transform: none;
        width: 100%;
        margin-bottom: 8px;
      }
    }
  </style>
</head>

<body>
  <div class="overlay"></div>

  <!-- Header with logo and user information -->
  <header class="container">
    <div class="row">
      <div class="logo" style="cursor:pointer;" onclick="location.href='./welcome.html'">
        <img src="./logo.png" alt="BytLearn" />
        <div>
          <div style="font-weight:800;font-size:22px;">BytLearn</div>
          <div style="font-size:12px;opacity:.8">AI-Powered Learning Platform</div>
        </div>
      </div>

      <div class="row" style="gap:10px;">
        <div style="text-align:right;">
          <div style="font-weight:600;">Welcome, <span id="uName">[Name]</span></div>
          <div style="opacity:.8;font-size:12px;" id="uEmail">student@bytlearn.app</div>
        </div>
        <a class="btn" href="./profile.html">Profile</a>
        <a class="btn" href="./welcome.html" 
           onclick="event.preventDefault(); localStorage.removeItem('authed'); location.href='./welcome.html';">
           Sign Out
        </a>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Progress breadcrumb showing the three-step selection process -->
    <div class="card" id="progress-pill" style="margin-bottom:8px;">
      <div class="progress">
        <span class="badge">Select Class</span>
        <span style="opacity:.7;">›</span>
        <span class="badge">Select Subject</span>
        <span style="opacity:.7;">›</span>
        <span class="badge">Select Chapter</span>
      </div>
    </div>

    <!-- Three panels for class, subject, and chapter selection -->
    <div class="grid stage">
      <div class="card panel center" id="panel-class">
        <h2>Choose Your Class</h2>
      </div>

      <div class="card panel right hidden" id="panel-subject">
        <h2>Choose Your Subject</h2>
      </div>

      <div class="card panel right hidden" id="panel-chapter">
        <h2>Choose Your Chapter</h2>
        <div id="chapters-list"></div>
      </div>
    </div>
  </main>

  <script>
    // Security: Redirect to login if user is not authenticated
    if (localStorage.getItem('authed') !== '1') {
      location.replace('./login.html');
    }

    // Initialize panels: ensure subject and chapter panels start hidden
    (function primePanels() {
      const subjectPanel = document.getElementById('panel-subject');
      if (subjectPanel) {
        subjectPanel.classList.add('hidden', 'right');
      }
      
      const chapterPanel = document.getElementById('panel-chapter');
      if (chapterPanel) {
        chapterPanel.classList.add('hidden', 'right');
      }
    })();

    // Display user information in the header
    (function(){
      const userName = localStorage.getItem('currentUserName') || 'Student';
      const userEmail = localStorage.getItem('currentUserEmail') || 'student@bytelearn.app';
      
      const nameElement = document.getElementById('uName');
      if (nameElement) {
        nameElement.textContent = userName;
      }
      
      const emailElement = document.getElementById('uEmail');
      if (emailElement) {
        emailElement.textContent = userEmail;
      }
    })();

    /**
     * Controls the visual flow of the three panels based on user's current step
     * @param {string} step - Current step: 'class', 'subject', or 'chapter'
     * 
     * Flow logic:
     * - 'class': Only class panel visible and centered
     * - 'subject': Class moves left, subject becomes center
     * - 'chapter': All three panels visible in cascade (far-left, left, center)
     */
    function setFlow(step) {
      const classPanel = document.getElementById('panel-class');
      const subjectPanel = document.getElementById('panel-subject');
      const chapterPanel = document.getElementById('panel-chapter');

      // Clear all positioning classes from panels
      [classPanel, subjectPanel, chapterPanel].forEach(panel => {
        if (panel) {
          panel.classList.remove('center', 'left', 'far-left', 'right', 'highlight');
        }
      });

      // Apply positioning based on current step
      if (step === 'class') {
        if (classPanel) {
          classPanel.classList.add('center', 'highlight');
        }
        if (subjectPanel) {
          subjectPanel.classList.add('right', 'hidden');
        }
        if (chapterPanel) {
          chapterPanel.classList.add('right', 'hidden');
        }
      } else if (step === 'subject') {
        if (classPanel) {
          classPanel.classList.add('left');
        }
        if (subjectPanel) {
          subjectPanel.classList.remove('hidden');
          subjectPanel.classList.add('center', 'highlight');
        }
        if (chapterPanel) {
          chapterPanel.classList.add('right', 'hidden');
        }
      } else if (step === 'chapter') {
        if (classPanel) {
          classPanel.classList.add('far-left');
        }
        if (subjectPanel) {
          subjectPanel.classList.add('left');
        }
        if (chapterPanel) {
          chapterPanel.classList.remove('hidden');
          chapterPanel.classList.add('center', 'highlight');
        }
      }

      // Remove highlight animation after it completes
      setTimeout(() => {
        [classPanel, subjectPanel, chapterPanel].forEach(panel => {
          if (panel) {
            panel.classList.remove('highlight');
          }
        });
      }, 900);

      // Scroll the stage into view smoothly
      const stageElement = document.querySelector('.stage');
      if (stageElement) {
        stageElement.scrollIntoView({ 
          behavior: 'smooth',
          block: 'start'
        });
      }
    }

    // Start with class selection panel active
    setFlow('class');

    /**
     * Fetches all available classes from the API and displays them
     * When a class is clicked:
     * 1. Saves class information to localStorage
     * 2. Transitions to subject selection panel
     * 3. Loads subjects for that class
     */
    async function loadClasses() {
      const response = await fetch('https://bytelearn-backend.onrender.com/classes');
      const classes = await response.json();
      const classPanel = document.getElementById('panel-class');
      
      classPanel.innerHTML = '<h2>Choose Your Class</h2>';
      
      classes.forEach(classItem => {
        const classDiv = document.createElement('div');
        classDiv.className = 'item';
        classDiv.innerHTML = `<a href="#">${classItem.class_name}</a>`;
        
        classDiv.querySelector('a').addEventListener('click', (event) => {
          event.preventDefault();
          
          // Store selected class information for later use
          localStorage.setItem('selectedClassId', classItem.class_id);
          localStorage.setItem('selectedClassName', classItem.class_name);
          
          // Move to subject selection
          setFlow('subject');
          loadSubjects(classItem.class_id);
        });
        
        classPanel.appendChild(classDiv);
      });
    }

    /**
     * Fetches subjects for a specific class and displays them
     * @param {number} classId - The ID of the selected class
     * 
     * When a subject is clicked:
     * 1. Saves subject information to localStorage
     * 2. Transitions to chapter selection panel
     * 3. Loads chapters for that subject
     */
    async function loadSubjects(classId) {
      const response = await fetch('https://bytelearn-backend.onrender.com/subjects');
      const subjects = await response.json();
      
      // Filter to show only subjects belonging to the selected class
      const filteredSubjects = subjects.filter(subject => 
        Number(subject.class_id) === Number(classId)
      );
      
      const subjectPanel = document.getElementById('panel-subject');
      subjectPanel.innerHTML = '<h2>Choose Your Subject</h2>';
      
      filteredSubjects.forEach(subject => {
        const subjectDiv = document.createElement('div');
        subjectDiv.className = 'item';
        subjectDiv.innerHTML = `<a href="#">${subject.subject_name}</a>`;
        
        subjectDiv.querySelector('a').addEventListener('click', (event) => {
          event.preventDefault();
          
          // Store selected subject information
          localStorage.setItem('selectedSubjectId', subject.subject_id);
          localStorage.setItem('selectedSubjectName', subject.subject_name);
          
          // Move to chapter selection
          setFlow('chapter');
          loadChapters(subject.subject_id);
        });
        
        subjectPanel.appendChild(subjectDiv);
      });
    }

    /**
     * Fetches chapters for a specific subject and displays them
     * @param {number} subjectId - The ID of the selected subject
     * 
     * When a chapter is clicked:
     * 1. Saves chapter information to localStorage
     * 2. Navigates to the learning page
     */
    async function loadChapters(subjectId) {
      const response = await fetch('https://bytelearn-backend.onrender.com/chapters');
      const chapters = await response.json();
      
      // Filter to show only chapters belonging to the selected subject
      const filteredChapters = chapters.filter(chapter =>
        Number(chapter.subject_id) === Number(subjectId)
      );
      
      const chaptersList = document.getElementById('chapters-list');
      chaptersList.innerHTML = '';
      
      filteredChapters.forEach(chapter => {
        const chapterDiv = document.createElement('div');
        chapterDiv.className = 'item';
        chapterDiv.innerHTML = `<a href="#">${chapter.chapter_name}</a>`;
        
        chapterDiv.querySelector('a').addEventListener('click', (event) => {
          event.preventDefault();
          
          // Store selected chapter information
          localStorage.setItem('selectedChapterId', chapter.chapter_id);
          localStorage.setItem('selectedChapterName', chapter.chapter_name);
          
          // Navigate to learning interface
          location.href = './learn.html';
        });
        
        chaptersList.appendChild(chapterDiv);
      });
    }

    // Load classes when the page finishes loading
    window.onload = function() {
      loadClasses();
    };
  </script>
</body>
</html>
