<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BytLearn ‚Äì Learn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --border: rgba(255,255,255,0.2);
      --glass: rgba(255,255,255,0.1);
      --text: #fff;
      --muted: rgba(255,255,255,0.85);
      --accent: #e5a054;
      --accent-glow: rgba(229, 160, 84, 0.3);
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial;
      color: var(--text);
      text-align: center;
    }
    body {
      background: linear-gradient(135deg, #7e22ce 0%, #f472b6 45%, #6366f1 100%);
      background-attachment: fixed;
      position: relative;
      overflow-x: hidden;
      font-size: 18px;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      pointer-events: none;
      z-index: 0;
    }
    .overlay { 
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
    }
    .container {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px;
      text-align: center;
    }
    main.container { 
      min-height: calc(100vh - 110px); 
    }
    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .logo { 
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo img { 
      width: 70px;
      height: 70px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.18);
      color: var(--text);
      text-decoration: none;
      transition: 150ms;
      backdrop-filter: blur(6px);
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
    }
    .btn:hover { 
      background: rgba(255,255,255,0.24);
    }
    .card {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      backdrop-filter: blur(8px);
      text-align: center;
    }
    #summary.card {
      max-width: 100%;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
    }
    #summary .grid {
      max-width: 100%;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      grid-template-columns: 1fr;
    }
    #summary .card {
      width: 100%;
      max-width: 100%;
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
    }
    .pills {
      display: grid;
      grid-template-columns: repeat(4, minmax(0,1fr)); 
      gap: 12px;
    }
    .pill {
      padding: 10px 16px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
      cursor: pointer;
    }
    .pill.active {
      background: rgba(255,255,255,0.2);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.12);
    }
    .hidden { 
      display: none !important; 
    }
    h2 { 
      margin: 0 0 12px;
      font-weight: 800;
      font-size: 28px;
      letter-spacing: -0.5px;
    }
    p { 
      color: var(--muted);
    }
    .grid { 
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media(min-width:768px) { 
      .grid { 
        grid-template-columns: 1fr 1fr;
      } 
    }
    #flashcards .grid { 
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 300px;
      position: relative;
      overflow: visible;
    }
    .flashcard-container {
      position: relative;
      width: 100%;
      max-width: 1000px;
      height: 350px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.18);
      border: 1px solid var(--border);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 150ms;
      z-index: 20;
      font-size: 20px;
      color: var(--text);
      user-select: none;
    }
    .nav-arrow:hover {
      background: rgba(255,255,255,0.24);
    }
    .nav-arrow.left { left: 10px; }
    .nav-arrow.right { right: 10px; }
    .nav-arrow.disabled {
      opacity: 1;
      cursor: pointer;
    }
    .flashcard-scrollbar-wrapper {
      width: 100%;
      max-width: 1000px;
      margin-top: 20px;
      padding: 0 10px;
    }
    .flashcard-scrollbar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      position: relative;
      cursor: pointer;
      backdrop-filter: blur(6px);
      border: 1px solid var(--border);
    }
    .flashcard-scrollbar-thumb {
      height: 100%;
      background: rgba(255,255,255,0.4);
      border-radius: 4px;
      position: absolute;
      left: 0;
      transition: background 0.2s;
      cursor: grab;
    }
    .flashcard-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.5);
    }
    .flashcard-scrollbar-thumb:active {
      cursor: grabbing;
      background: rgba(255,255,255,0.6);
    }
    h2, h3, h1, p, .badge, .subtitle, .title, .lead, .actions, .stats, .pill, .item a, .list, .li {
      text-align: center !important;
    }
    .flashcard {
      transition: box-shadow 0.2s;
    }
    .flashcard:active, .flashcard:focus {
      box-shadow: 0 0 0 4px #a21caf;
    }
    .summary-text {
      white-space: pre-wrap;
      text-align: left;
      font-size: 16px;
      margin: 24px 40px;
      padding: 20px 32px;
      line-height: 1.8;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      letter-spacing: 0.01em;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      border-left: 4px solid var(--accent);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
    }
    .summary-text .heading {
      display: block !important;
      font-weight: 800 !important;
      color: var(--accent) !important;
      font-size: 22px !important;
      margin: 32px 0 16px 0 !important;
      padding-bottom: 12px !important;
      border-bottom: 3px solid var(--accent) !important;
      text-align: left !important;
      font-family: 'Playfair Display', 'Inter', serif !important;
      letter-spacing: -0.02em !important;
      width: 100%;
      text-shadow: 0 2px 8px var(--accent-glow);
      position: relative;
    }
    .summary-text .heading::before {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #fff 0%, var(--accent) 100%);
      box-shadow: 0 0 10px var(--accent-glow);
    }
    .summary-text .heading:first-child {
      margin-top: 0 !important;
    }
    .summary-text p {
      margin: 12px 0;
      text-align: left;
      color: rgba(255,255,255,0.95);
      font-weight: 500;
    }
    .summary-text strong {
      color: #fff;
      font-weight: 700;
    }
    .flashcard-text {
      white-space: pre-wrap;
      font-family: "Times New Roman", Times, serif;
      text-align: justify;
      font-size: 19px;
      margin: 16px 30px;
      padding: 0 0 0 2px;
    }
    .card-item {
      position: absolute;
      width: 480px;
      height: 350px;
      border-radius: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: var(--glass);
      border: 1px solid var(--border);
      backdrop-filter: blur(8px);
      transition: transform 0.4s ease, opacity 0.4s ease, left 0.4s ease;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      user-select: none;
    }
    .card-item.visited {
      left: -120px;
      transform: scale(0.75);
      opacity: 0.5;
      z-index: 5;
    }
    .card-item.visited:nth-child(1) {
      left: -120px;
      z-index: 5;
    }
    .card-item.visited:nth-child(2) {
      left: -100px;
      z-index: 6;
    }
    .card-item.visited:nth-child(3) {
      left: -80px;
      z-index: 7;
    }
    .card-item.current {
      left: 50%;
      transform: translateX(-50%) scale(1);
      opacity: 1;
      z-index: 10;
    }
    .card-item.unvisited {
      left: auto;
      right: -120px;
      transform: scale(0.75);
      opacity: 0.5;
      z-index: 5;
    }
    .card-item.unvisited:nth-last-child(1) {
      right: -120px;
      z-index: 5;
    }
    .card-item.unvisited:nth-last-child(2) {
      right: -100px;
      z-index: 6;
    }
    .card-item.unvisited:nth-last-child(3) {
      right: -80px;
      z-index: 7;
    }
    .card-front {
      background: linear-gradient(135deg, rgba(162, 28, 175, 0.4) 0%, rgba(109, 40, 217, 0.4) 100%);
    }
    .card-back {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.25) 0%, rgba(245, 158, 11, 0.25) 100%);
    }
   
    .ai-disclaimer {
      padding: 1px 1px;
      margin-bottom: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .ai-disclaimer-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 6px;
      background-color: #38bdf8;
      color: white;
      font-weight: bold;
      font-style: italic;
      font-size: 14px;
      flex-shrink: 0;
      font-family: serif;
    }

    .ai-disclaimer-text {
      font-size: 13px;
      line-height: 1.5;
      color: rgba(255, 255, 255, 0.9);
      text-align: left;
    }


    .flashcard-title {
      font-size: 20px;
      font-weight: 800;
      color: #ffffff;
      margin-bottom: 16px;
      text-align: center;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      letter-spacing: 0.3px;
    }
    .flashcard-content {
      font-size: 17px;
      line-height: 1.8;
      text-align: justify;
      text-align-last: center;
      color: #ffffff;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow-y: auto;
      max-height: 100%;
      font-weight: 600;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
      letter-spacing: 0.3px;
      word-spacing: 0.5px;
      padding: 0 8px;
      hyphens: auto;
    }
    .flashcard-prompt {
      font-size: 22px;
      font-weight: 800;
      color: #ffffff;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
    }

    /* Quiz Modal Styles */
    .quiz-modal {
      position: fixed;
      inset: 0;
      background: rgba(10, 5, 30, 0.85);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .quiz-modal.active {
      display: flex;
    }

    .quiz-modal-content {
      background: linear-gradient(145deg, #1e1b4b, #312e81);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 24px;
      padding: 24px;
      max-width: 1100px;
      width: 100%;
      max-height: 95vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
      display: flex;
      gap: 24px;
    }

    .quiz-nav {
      flex: 0 0 200px;
      background: rgba(0,0,0,0.2);
      border-radius: 16px;
      padding: 15px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
      gap: 12px;
      align-content: start;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .quiz-nav-item {
      width: 42px;
      height: 42px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      color: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 15px;
      font-weight: 600;
    }

    .quiz-nav-item:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.4);
      color: #fff;
    }

    .quiz-nav-item.answered {
      background: rgba(99, 102, 241, 0.3);
      border-color: rgba(99, 102, 241, 0.7);
      color: #fff;
    }

    .quiz-nav-item.current {
      background: #6366f1;
      color: white;
      border-color: #818cf8;
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
    }

    .quiz-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding-right: 10px;
    }

    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      flex-wrap: wrap;
      gap: 15px;
    }

    .quiz-timer {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 20px;
      font-weight: 700;
    }

    .quiz-progress {
      font-size: 16px;
      font-weight: 600;
      background: rgba(0,0,0,0.2);
      padding: 8px 16px;
      border-radius: 8px;
    }

    .quiz-question-card {
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
    }

    .quiz-question-text {
      font-size: 22px;
      font-weight: 500;
      margin-bottom: 24px;
      line-height: 1.5;
      text-align: left;
    }

    .quiz-options {
      display: grid;
      gap: 15px;
    }

    .quiz-option {
      background: transparent;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      padding: 15px 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 15px;
      text-align: left;
    }

    .quiz-option:hover {
      background: rgba(255,255,255,0.1);
      border-color: #a5b4fc;
    }

    .quiz-option.selected {
      background: rgba(99, 102, 241, 0.3);
      border-color: #6366f1;
    }

    .quiz-option.correct {
      background: rgba(34, 197, 94, 0.2);
      border-color: #22c55e;
      pointer-events: none;
    }

    .quiz-option.incorrect {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      pointer-events: none;
    }

    .quiz-option.disabled {
      pointer-events: none;
      opacity: 0.7;
    }

    .option-letter {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      font-weight: 700;
      flex-shrink: 0;
    }

    .option-text {
      flex: 1;
      font-size: 16px;
      line-height: 1.5;
    }

    .quiz-explanation {
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      display: none;
      text-align: left;
    }

    .quiz-explanation.show {
      display: block;
    }

    .quiz-explanation-title {
      font-weight: 700;
      margin-bottom: 8px;
      color: #facc15;
    }

    .quiz-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      margin-top: auto;
      padding-top: 24px;
      border-top: 1px solid rgba(255,255,255,0.2);
    }

    .quiz-btn {
      padding: 12px 28px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quiz-btn-primary {
      background: #6366f1;
      color: white;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
    }

    .quiz-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
    }

    .quiz-btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .quiz-btn-secondary {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .quiz-btn-secondary:hover {
      background: rgba(255,255,255,0.2);
    }

    .quiz-result-card {
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
    }

    .quiz-result-score {
      font-size: 72px;
      font-weight: 800;
      margin: 20px 0;
      background: linear-gradient(135deg, #facc15, #fb923c);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .quiz-result-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .quiz-result-detail {
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 12px;
    }

    .quiz-result-detail-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .quiz-result-detail-label {
      font-size: 14px;
      opacity: 0.8;
    }

    /* Alert/Confirm Modal Styles */
    .alert-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(10, 5, 30, 0.85);
      backdrop-filter: blur(10px);
      z-index: 2000; /* Higher than quiz modal */
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .alert-modal-overlay.active {
      display: flex;
    }

    .alert-modal-content {
      background: linear-gradient(145deg, #1e1b4b, #312e81);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      padding: 24px 32px;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      animation: modalFadeIn 0.2s ease-out;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .alert-modal-content h3 {
      font-size: 22px;
      font-weight: 700;
      margin: 0 0 12px;
      color: #fff;
      text-align: center;
    }

    .alert-modal-content p {
      font-size: 16px;
      color: var(--muted);
      line-height: 1.6;
      margin: 0 0 24px;
      text-align: center;
    }

    .alert-modal-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .alert-btn {
      padding: 10px 24px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 100px;
    }

    .alert-btn-primary {
      background: #6366f1;
      color: white;
    }
    .alert-btn-primary:hover {
      background: #4f46e5;
    }

    .alert-btn-secondary {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .alert-btn-secondary:hover {
      background: rgba(255,255,255,0.2);
    }

    /* Doubt Section Styles */
    #doubts {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      backdrop-filter: blur(12px);
      text-align: left;
      width: 100%;
      max-width: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 280px);
    }
    #doubts .row {
      margin-bottom: 18px;
      align-items: center;
      flex-shrink: 0;
    }
    #doubts h2 {
      font-size: 32px;
      font-weight: 800;
      margin: 0;
      text-align: left;
    }
    #doubts .pill {
      cursor: default;
      font-size: 20px;
      padding: 10px 18px;
    }
    #rag-chat-history {
      flex: 1;
      overflow-y: auto;
      background: rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 18px;
      margin-bottom: 18px;
      text-align: left;
      font-size: 18px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }
    #rag-chat-history div {
      text-align: left;
    }
    #rag-chat-history .ai-disclaimer {
      margin: 0 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
    }
    #rag-chat-history .ai-disclaimer-icon {
      flex-shrink: 0;
      font-size: 13px;
      opacity: 0.5;
    }
    #rag-chat-history .ai-disclaimer-text {
      line-height: 1.4;
      margin: 0;
      font-weight: 400;
      text-align: left;
    }
    #rag-chat-form {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-shrink: 0;
    }
    #rag-chat-input {
      flex: 1;
      padding: 14px 18px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.13);
      color: var(--text);
      font-size: 18px;
      outline: none;
      text-align: left;
    }
    #rag-chat-input:disabled {
      background: rgba(255,255,255,0.06);
    }
    #rag-chat-input::placeholder {
      color: rgba(255,255,255,0.7);
    }
    #rag-chat-form button {
      padding: 14px 28px;
      font-size: 18px;
    }
    /* Animations */
    @keyframes pulse {
      0%, 100% { 
        opacity: 0.6;
      }
      50% { 
      }
    }
    /* Scrollbar Styles */
    .summary-text::-webkit-scrollbar {
      width: 8px;
    }
    .summary-text::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }
    .summary-text::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }
    .summary-text::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.3);
    }
  </style>
</head>

<body>
  <div class="overlay"></div>
  
  <header class="container">
    <div class="row">
      <div class="logo" style="cursor:pointer;" onclick="location.href='./welcome.html'">
        <img src="./logo.png" alt="BytLearn" />
        <div>
          <div style="font-weight:800;font-size:22px;">BytLearn</div>
          <div style="font-size:12px;opacity:.8">Learning Workspace ‚Äì <span id="lName">[Name]</span></div>
        </div>
      </div>
      <div class="row" style="gap:10px;">
        <a class="btn" href="./dashboard.html">Dashboard</a>
        <a class="btn" href="./profile.html" title="Profile">Profile</a>
        <a class="btn" href="./welcome.html"
           onclick="event.preventDefault(); localStorage.removeItem('authed'); location.href='./welcome.html';">
          Sign Out
        </a>
      </div>
    </div>
  </header>
  
  <main class="container">
    <div class="card" style="margin-bottom:12px;">
      <div class="pills">
        <button class="pill active" data-tab="summary">Summaries</button>
        <button class="pill" data-tab="flashcards">Flashcards</button>
        <button class="pill" data-tab="doubts">Doubt Asking</button>
        <button class="pill" data-tab="quizzes">Quizzes</button>
      </div>
    </div>
    
    <section id="summary" class="card tab">
      <div class="row" style="justify-content:space-between;">
        <h2>Chapter Summary</h2>
        <span class="pill" style="cursor:default;">Summary</span>
      </div>
      <p></p>
      <div class="grid" style="margin-top:10px">
      </div>
    </section>
    
    <section id="flashcards" class="card tab hidden">
      <div class="row" style="justify-content:space-between;">
        <h2>Flashcards</h2>
        <span class="pill" style="cursor:default;">Recall</span>
      </div>
      <div class="grid" style="margin-top:10px"></div>
    </section>
    
    <section id="doubts" class="tab hidden"
  style="background:var(--glass);border:1px solid var(--border);border-radius:22px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.18);backdrop-filter:blur(12px);text-align:left;width:100%;max-width:100%;margin:0;display:flex;flex-direction:column;height:calc(100vh - 280px);">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:18px;flex-shrink:0;">
        <h2 style="font-size:32px;font-weight:800;margin:0;text-align:left;">Ask a Doubt</h2>
        <span class="pill" style="cursor:default;font-size:20px;padding:10px 18px;">?</span>
      </div>
      
      <div class="ai-disclaimer">
        <div class="ai-disclaimer-icon">i</div>
        <p class="ai-disclaimer-text">
          <strong>AI-Generated Content:</strong> Responses are powered by AI and may not be 100% accurate. Always verify important information with your teacher or textbook.
        </p>
      </div>
      
      <div id="rag-chat-history" style="flex:1;overflow-y:auto;background:rgba(255,255,255,0.08);border-radius:18px;padding:18px;margin-bottom:18px;text-align:left;font-size:18px;box-shadow:inset 0 0 0 1px rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:8px;min-height:0;">
        <div style="color:var(--muted);text-align:left;">Clear your Doubts...</div>
      </div>
      <form id="rag-chat-form" style="display:flex;gap:12px;align-items:center;flex-shrink:0;" autocomplete="off" onsubmit="return false;">
        <input id="rag-chat-input" type="text" placeholder="Type your doubt..." style="flex:1;padding:14px 18px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,0.13);color:var(--text);font-size:18px;outline:none;text-align:left;" />
        <button type="submit" class="btn" style="padding:14px 28px;font-size:18px;">Send</button>
      </form>
    </section>
    
    <!-- Quizzes Section -->
    <section id="quizzes" class="card tab hidden">
      <div class="row" style="justify-content:space-between;">
        <h2>Quick Quiz</h2>
        <span class="pill" style="cursor:default;">Practice</span>
      </div>
      
     <!-- AI Disclaimer for Quizzes -->
      <div class="ai-disclaimer">
        <div class="ai-disclaimer-icon">i</div>
        <p class="ai-disclaimer-text">
          <strong>AI-Generated Content:</strong> Quiz questions are AI-generated and may contain errors. Use for practice and always refer to your textbook for exam preparation.
        </p>
      </div>
      <p>Test yourself with chapter-based MCQ questions and instant feedback.</p>
      
      <div id="quiz-controls" style="margin:18px 0;">
        <button id="generate-quiz-btn" class="btn" style="font-size:16px;padding:12px 28px;">üéØ Generate Quiz</button>
      </div>
      
      <div id="quiz-placeholder"></div>
    </section>
  </main>

  <!-- Quiz Modal -->
  <div class="quiz-modal" id="quizModal">
    <div class="quiz-modal-content">
      <div class="quiz-nav" id="quizNav"></div>
      <div class="quiz-main">
        <div class="quiz-header">
          <div class="quiz-timer" id="quizTimer">
            <span>‚è±Ô∏è</span>
            <span id="timerDisplay">00:00</span>
          </div>
          <div class="quiz-progress" id="quizProgress">Question 1 of 10</div>
          <button class="btn" id="closeQuizBtn" style="padding:8px 16px;">‚úï Close</button>
        </div>
        
        <div id="quizContent"></div>
        
        <div class="quiz-controls" id="quizControls">
          <button class="quiz-btn quiz-btn-secondary" id="prevQuestionBtn">‚Üê Previous</button>
          <button class="quiz-btn quiz-btn-primary" id="nextQuestionBtn">Next ‚Üí</button>
          <button class="quiz-btn quiz-btn-primary" id="submitQuizBtn">Finish Quiz</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Generic Alert/Confirm Modal -->
  <div class="alert-modal-overlay" id="alertModal">
    <div class="alert-modal-content">
      <h3 id="alertModalTitle">Alert</h3>
      <p id="alertModalMessage">This is a message.</p>
      <div class="alert-modal-actions">
        <button class="alert-btn alert-btn-secondary" id="alertCancelBtn">Cancel</button>
        <button class="alert-btn alert-btn-primary" id="alertOkBtn">OK</button>
      </div>
    </div>
  </div>

  <script>
    // Auth check
    if (localStorage.getItem('authed') !== '1') {
      location.replace('./login.html');
    }

    // --- Custom Alert/Confirm Modal Logic ---
    const alertModal = document.getElementById('alertModal');
    const alertModalTitle = document.getElementById('alertModalTitle');
    const alertModalMessage = document.getElementById('alertModalMessage');
    const alertOkBtn = document.getElementById('alertOkBtn');
    const alertCancelBtn = document.getElementById('alertCancelBtn');

    let currentModalResolver;

    function showAlert(message, title = 'Notification') {
      alertModalTitle.textContent = title;
      alertModalMessage.textContent = message;
      alertCancelBtn.style.display = 'none';
      alertOkBtn.textContent = 'OK';
      alertModal.classList.add('active');

      return new Promise(resolve => {
        currentModalResolver = { resolve, type: 'alert' };
      });
    }

    function showConfirm(message, title = 'Confirmation') {
      alertModalTitle.textContent = title;
      alertModalMessage.textContent = message;
      alertCancelBtn.style.display = 'inline-flex';
      alertOkBtn.textContent = 'Confirm';
      alertModal.classList.add('active');

      return new Promise(resolve => {
        currentModalResolver = { resolve, type: 'confirm' };
      });
    }

    alertOkBtn.addEventListener('click', () => {
      if (!currentModalResolver) return;
      alertModal.classList.remove('active');
      if (currentModalResolver.type === 'alert') {
        currentModalResolver.resolve();
      } else {
        currentModalResolver.resolve(true);
      }
      currentModalResolver = null;
    });

    alertCancelBtn.addEventListener('click', () => {
      if (!currentModalResolver || currentModalResolver.type !== 'confirm') return;
      alertModal.classList.remove('active');
      currentModalResolver.resolve(false);
      currentModalResolver = null;
    });
    // --- End Custom Modal Logic ---

    const pills = document.querySelectorAll(".pill[data-tab]");
    const tabs = document.querySelectorAll(".tab");

    pills.forEach(p => p.addEventListener("click", () => {
      pills.forEach(pp => pp.classList.remove("active"));
      p.classList.add("active");
      const id = p.getAttribute("data-tab");
      tabs.forEach(t => t.classList.add("hidden"));
      document.getElementById(id)?.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }));

    (function(){
      const n = localStorage.getItem("currentUserName") || "Student";
      const el = document.getElementById("lName");
      if (el) el.textContent = n;
    })();

    async function loadSummaries() {
      const grid = document.querySelector("#summary .grid");
      if (!grid) return;
      grid.innerHTML = '<div class="loading-text">Loading summaries...</div>';
      const chapterId = Number(localStorage.getItem("selectedChapterId"));
      if (!chapterId) {
        grid.innerHTML = '<div class="error-message">No chapter selected. Go to Dashboard and pick a chapter.</div>';
        return;
      }
      try {
        const res = await fetch("http://127.0.0.1:8000/summaries");
        const summaries = await res.json();
        const filtered = summaries.filter((s) => s.chapter_id === chapterId);
        if (filtered.length > 0) {
          grid.innerHTML = "";
          filtered.forEach((summary) => {
            let text = summary.summary_data;
            const lines = text.split('\n');
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();
              if (line.startsWith('Section:') || line.startsWith('Section ') || /^\d+\.\d+\s/.test(line) || line === 'Key Terms' || line === 'Chapter Summary' || line === 'High-Yield Exam Facts') {
                lines[i] = '<span class="heading">' + lines[i] + '</span>';
              }
            }
            text = lines.join('\n');
            grid.innerHTML += `<div class="summary-text">${text}</div>`;
          });
        } else {
          grid.innerHTML = '<div class="error-message">No summaries found for this chapter.</div>';
        }
      } catch (e) {
        grid.innerHTML = `<div class="error-message">Error loading summaries: ${e.message}</div>`;
      }
    }

    async function loadFlashcards() {
      const grid = document.querySelector("#flashcards .grid");
      if (!grid) return;
      grid.innerHTML = '<div class="loading-text">Loading flashcards...</div>';
      const chapterId = Number(localStorage.getItem("selectedChapterId"));
      if (!chapterId) {
        grid.innerHTML = '<div class="error-message">No chapter selected. Go to Dashboard and pick a chapter.</div>';
        return;
      }
      try {
        const res = await fetch("http://127.0.0.1:8000/flashcards");
        const flashcards = await res.json();
        const filtered = flashcards.filter((f) => f.chapter_id === chapterId);
        if (filtered.length > 0) {
          grid.innerHTML = `
            <div class="nav-arrow left" id="prev-card">‚Üê</div>
            <div class="flashcard-container" id="card-container"></div>
            <div class="nav-arrow right" id="next-card">‚Üí</div>
            <div class="flashcard-scrollbar-wrapper">
              <div class="flashcard-scrollbar" id="flashcard-scrollbar">
                <div class="flashcard-scrollbar-thumb" id="flashcard-scrollbar-thumb"></div>
              </div>
            </div>
          `;
          const container = document.getElementById('card-container');
          const prevBtn = document.getElementById('prev-card');
          const nextBtn = document.getElementById('next-card');
          const scrollbar = document.getElementById('flashcard-scrollbar');
          const scrollbarThumb = document.getElementById('flashcard-scrollbar-thumb');
          let currentCardIndex = 0;
          let isFlipped = false;
          const allCards = filtered.map((flashcard) => {
            const raw = (flashcard.flashcard_data || '').replace(/\r/g, '');
            let topic = '', keypoint = '';
            if (/Key Point:/i.test(raw)) {
              const parts = raw.split(/Key Point:/i);
              topic = parts[0].trim();
              keypoint = parts.slice(1).join('Key Point:').trim();
            } else if (raw.includes('|')) {
              const parts = raw.split('|');
              topic = parts[0].trim().replace(/\|+$/, "");
              keypoint = parts.slice(1).join(' ').trim();
            } else {
              const lines = raw.split('\n').map(s=>s.trim()).filter(Boolean);
              topic = lines.shift() || '';
              keypoint = lines.join(' ') || '';
            }
            topic = topic.replace(/\|/g, '').replace(/\[\d+\]/g, '').trim();
            keypoint = keypoint.replace(/\|/g, '').replace(/\[\d+\]/g, '').trim();
            return { topic, keypoint };
          });
          function createCard(index, cardData) {
            const cardEl = document.createElement('div');
            cardEl.className = 'card-item card-front';
            cardEl.dataset.index = index;
            cardEl.innerHTML = `<div class="flashcard-prompt">Tap to reveal (${index + 1}/${allCards.length})</div>`;
            cardEl.addEventListener('click', function() {
              if (parseInt(cardEl.dataset.index) !== currentCardIndex) return;
              if (!isFlipped) {
                cardEl.classList.remove('card-front');
                cardEl.classList.add('card-back');
                cardEl.innerHTML = `
                  <div class="flashcard-title">${cardData.topic}</div>
                  <div class="flashcard-content">${cardData.keypoint}</div>
                `;
                isFlipped = true;
              } else {
                cardEl.classList.remove('card-back');
                cardEl.classList.add('card-front');
                cardEl.innerHTML = `<div class="flashcard-prompt">Tap to reveal (${index + 1}/${allCards.length})</div>`;
                isFlipped = false;
              }
            });
            return cardEl;
          }
          function updateScrollbar() {
            const thumbWidth = (1 / allCards.length) * 100;
            const thumbPosition = (currentCardIndex / allCards.length) * 100;
            scrollbarThumb.style.width = thumbWidth + '%';
            scrollbarThumb.style.left = thumbPosition + '%';
          }
          function updateCardPositions() {
            const cards = Array.from(container.children);
            cards.forEach((card, idx) => {
              card.classList.remove('visited', 'current', 'unvisited');
              if (idx < currentCardIndex) {
                card.classList.add('visited');
              } else if (idx === currentCardIndex) {
                card.classList.add('current');
              } else {
                card.classList.add('unvisited');
              }
            });
            prevBtn.classList.toggle('disabled', currentCardIndex === 0);
            nextBtn.classList.toggle('disabled', currentCardIndex === allCards.length - 1);
            updateScrollbar();
          }
          function goToNext() {
            if (currentCardIndex > 0) {
              currentCardIndex--;
              isFlipped = false;
              updateCardPositions();
            }
          }
          function goToPrev() {
            if (currentCardIndex < allCards.length - 1) {
              currentCardIndex++;
              isFlipped = false;
              updateCardPositions();
            }
          }
          prevBtn.addEventListener('click', goToPrev);
          nextBtn.addEventListener('click', goToPrev);
          scrollbar.addEventListener('click', function(e) {
            if (e.target === scrollbarThumb) return;
            const rect = scrollbar.getBoundingClientRect();
            const clickPosition = (e.clientX - rect.left) / rect.width;
            currentCardIndex = Math.round(clickPosition * (allCards.length - 1));
            isFlipped = false;
            updateCardPositions();
          });
          let isDragging = false;
          let startX = 0;
          let startIndex = 0;
          scrollbarThumb.addEventListener('mousedown', function(e) {
            isDragging = true;
            startX = e.clientX;
            startIndex = currentCardIndex;
            e.preventDefault();
          });
          document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            const rect = scrollbar.getBoundingClientRect();
            const deltaX = e.clientX - startX;
            const deltaIndex = Math.round((deltaX / rect.width) * allCards.length);
            const newIndex = Math.max(0, Math.min(allCards.length - 1, startIndex + deltaIndex));
            if (newIndex !== currentCardIndex) {
              currentCardIndex = newIndex;
              isFlipped = false;
              updateCardPositions();
            }
          });
          document.addEventListener('mouseup', function() {
            isDragging = false;
          });
          allCards.forEach((cardData, idx) => {
            const card = createCard(idx, cardData);
            container.appendChild(card);
          });
          updateCardPositions();
          container.addEventListener('wheel', function(e) {
            const threshold = 30;
            if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
              if (Math.abs(e.deltaX) > threshold) {
                if (e.deltaX > 0 && currentCardIndex < allCards.length - 1) {
                  currentCardIndex++;
                  isFlipped = false;
                  updateCardPositions();
                  e.preventDefault();
                } else if (e.deltaX < 0 && currentCardIndex > 0) {
                  currentCardIndex--;
                  isFlipped = false;
                  updateCardPositions();
                  e.preventDefault();
                }
              }
            } else if (Math.abs(e.deltaY) > threshold) {
              if (e.deltaY > 0 && currentCardIndex < allCards.length - 1) {
                currentCardIndex++;
                isFlipped = false;
                updateCardPositions();
                e.preventDefault();
              } else if (e.deltaY < 0 && currentCardIndex > 0) {
                currentCardIndex--;
                isFlipped = false;
                updateCardPositions();
                e.preventDefault();
              }
            }
          }, { passive: false });
        } else {
          grid.innerHTML = '<div class="error-message">No flashcards found for this chapter.</div>';
        }
      } catch (e) {
        grid.innerHTML = `<div class="error-message">Error loading flashcards: ${e.message}</div>`;
      }
    }

    const ragChatForm = document.getElementById('rag-chat-form');
    const ragChatInput = document.getElementById('rag-chat-input');
    const ragChatHistory = document.getElementById('rag-chat-history');
    let isFirstDoubt = true;

    if (ragChatForm && ragChatInput && ragChatHistory) {
      ragChatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const question = ragChatInput.value.trim();
        if (!question) return;

        if (isFirstDoubt) {
          ragChatHistory.innerHTML = '';
          isFirstDoubt = false;
        }

        ragChatHistory.innerHTML += `<div style="text-align:left;"><span style="font-weight:700;color:#233876;">You:</span> <span style="color:#fff;">${question}</span></div>`;
        ragChatInput.value = '';
        ragChatInput.disabled = true;
        const loadingId = 'rag-loading-' + Date.now();
        ragChatHistory.innerHTML += `<div id="${loadingId}" style="color:#aaa;text-align:left;">AI is thinking...</div>`;
        ragChatHistory.scrollTop = ragChatHistory.scrollHeight;

        try {
          const studentId = localStorage.getItem('currentUserId') || null;
          const chapterId = localStorage.getItem('selectedChapterId') || null;

          const backendRes = await fetch('http://127.0.0.1:8000/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: question, student_id: studentId, chapter_id: chapterId })
          });
          
          const backendData = await backendRes.json();
          
          if (backendRes.ok && backendData && backendData.doubt_id) {
            const doubtId = backendData.doubt_id;
            document.getElementById(loadingId).innerHTML = 'Processing your question...';
            
            let attempts = 0;
            const maxAttempts = 30;

            // This function will poll for the response safely.
            async function pollForDoubtResponse(doubtId) {
              attempts++;
              if (attempts > maxAttempts) {
                document.getElementById(loadingId)?.remove();
                ragChatHistory.innerHTML += `<div style="color:#f55;text-align:left;">Sorry, the request took too long. Please try again.</div>`;
                ragChatHistory.scrollTop = ragChatHistory.scrollHeight;
                ragChatInput.disabled = false;
                ragChatInput.focus();
                return;
              }

              try {
                const pollRes = await fetch(`http://127.0.0.1:8000/doubt/${doubtId}`);
                const pollData = await pollRes.json();
                
                // Check if the response is no longer null (meaning it's ready)
                if (pollData.response !== null && pollData.response !== undefined) {
                  // Success! Stop polling and display the answer.
                  document.getElementById(loadingId)?.remove();
                  ragChatHistory.innerHTML += `<div style="text-align:left;"><span style="font-weight:700;color:#ffe066;">AI:</span> <span style="color:var(--muted);">${pollData.response}</span></div>`;
                  ragChatHistory.scrollTop = ragChatHistory.scrollHeight;
                  ragChatInput.disabled = false;
                  ragChatInput.focus();
                } else {
                  // No response yet, schedule the next poll.
                  setTimeout(() => pollForDoubtResponse(doubtId), 1500);
                }
              } catch (err) {
                console.warn('Polling error:', err);
                // On error, wait a bit and try again.
                setTimeout(() => pollForDoubtResponse(doubtId), 1500);
              }
            }

            // Start the first poll.
            setTimeout(() => pollForDoubtResponse(doubtId), 1000);

          } else {
            throw new Error('Failed to create doubt');
          }
        } catch (err) {
          document.getElementById(loadingId)?.remove();
          ragChatHistory.innerHTML += `<div style="color:#f55;text-align:left;">Error: Could not get answer. ${err.message}</div>`;
          ragChatHistory.scrollTop = ragChatHistory.scrollHeight;
          ragChatInput.disabled = false;
          ragChatInput.focus();
        }
      });
    }

    // Quiz Module
    const quizModal = document.getElementById('quizModal');
    const generateQuizBtn = document.getElementById('generate-quiz-btn');
    const closeQuizBtn = document.getElementById('closeQuizBtn');
    const quizContent = document.getElementById('quizContent');
    const quizProgress = document.getElementById('quizProgress');
    const timerDisplay = document.getElementById('timerDisplay');
    const prevQuestionBtn = document.getElementById('prevQuestionBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const submitQuizBtn = document.getElementById('submitQuizBtn');
    const quizNav = document.getElementById('quizNav');

    let quizData = [];
    let currentQuestion = 0;
    let userAnswers = [];
    let quizStartTime = null;
    let timerInterval = null;
    let quizSubmitted = false;

    function startTimer() {
      quizStartTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - quizStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}m ${secs}s`;
    }

    if (generateQuizBtn) {
      generateQuizBtn.addEventListener('click', async function() {
        const chapterId = Number(localStorage.getItem("selectedChapterId"));
        
        if (!chapterId) {
          await showAlert('Please select a chapter from the Dashboard first.', 'Chapter Not Selected');
          return;
        }

        generateQuizBtn.disabled = true;
        generateQuizBtn.textContent = '‚è≥ Generating...';

        try {
          const response = await fetch('http://127.0.0.1:8000/generate_quiz', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chapter_id: chapterId })
          });

          const data = await response.json();

          if (data.quiz && data.quiz.length > 0) {
            // Adapt data from backend to match the format required by this quiz UI
            quizData = data.quiz.map(q => ({
              ...q,
              correct_answer: q.correct_answer.charCodeAt(0) - 65, // Convert "A" -> 0, "B" -> 1, etc.
              options: q.options.map(opt => opt.substring(opt.indexOf(')') + 1).trim()) // Strip "A) " from options
            }));

            userAnswers = new Array(quizData.length).fill(null);
            currentQuestion = 0;
            quizSubmitted = false;
            
            quizModal.classList.add('active');
            startTimer();
            renderQuestion();
          } else {
            await showAlert('No quiz questions could be generated for this chapter.', 'Quiz Generation Failed');
          }
        } catch (error) {
          await showAlert('Error generating quiz: ' + error.message, 'Error');
        } finally {
          generateQuizBtn.disabled = false;
          generateQuizBtn.textContent = 'üéØ Generate Quiz';
        }
      });
    }

    if (closeQuizBtn) {
      closeQuizBtn.addEventListener('click', async () => {
        if (quizSubmitted || await showConfirm('Are you sure you want to close? Your progress will be lost.', 'Confirm Close')) {
          quizModal.classList.remove('active');
          stopTimer();
          quizData = [];
          userAnswers = [];
          currentQuestion = 0;
          quizSubmitted = false;
          quizNav.style.display = 'grid';
        }
      });
    }

    function renderQuizNav() {
      if (!quizNav) return;
      quizNav.innerHTML = '';
      quizData.forEach((_, idx) => {
        const navItem = document.createElement('div');
        navItem.className = 'quiz-nav-item';
        navItem.textContent = idx + 1;
        if (idx === currentQuestion) {
          navItem.classList.add('current');
        }
        if (userAnswers[idx] !== null) {
          navItem.classList.add('answered');
        }
        navItem.addEventListener('click', () => {
          if (!quizSubmitted) {
            currentQuestion = idx;
            renderQuestion();
          }
        });
        quizNav.appendChild(navItem);
      });
    }

    function renderQuestion() {
      if (!quizData.length) return;

      renderQuizNav();

      const q = quizData[currentQuestion];
      quizProgress.textContent = `Question ${currentQuestion + 1} of ${quizData.length}`;
      
      let optionsHtml = q.options.map((option, index) => {
        const letter = String.fromCharCode(65 + index);
        let optionClass = 'quiz-option';

        if (quizSubmitted) {
          optionClass += ' disabled';
          if (index === q.correct_answer) {
            optionClass += ' correct';
          } else if (index === userAnswers[currentQuestion]) {
            optionClass += ' incorrect';
          }
        } else if (userAnswers[currentQuestion] === index) {
          optionClass += ' selected';
        }

        return `<div class="${optionClass}" data-index="${index}">
                  <div class="option-letter">${letter}</div>
                  <div class="option-text">${option}</div>
                </div>`;
      }).join('');

      let explanationHtml = '';
      if (quizSubmitted && q.explanation) {
        explanationHtml = `<div class="quiz-explanation show">
                             <div class="quiz-explanation-title">üí° Explanation</div>
                             <div>${q.explanation}</div>
                           </div>`;
      }

      quizContent.innerHTML = `
        <div class="quiz-question-card">
          <div class="quiz-question-text"><strong>Q${currentQuestion + 1}.</strong> ${q.question}</div>
          <div class="quiz-options">${optionsHtml}</div>
          ${explanationHtml}
        </div>
      `;

      if (!quizSubmitted) {
        document.querySelectorAll('.quiz-option').forEach(option => {
          option.addEventListener('click', (e) => {
            const selectedIndex = parseInt(e.currentTarget.dataset.index);
            userAnswers[currentQuestion] = selectedIndex;
            renderQuestion(); // Re-render to show selection and update nav
          });
        });
      }

      // Update button visibility
      prevQuestionBtn.style.display = currentQuestion > 0 ? 'block' : 'none';
      nextQuestionBtn.style.display = currentQuestion < quizData.length - 1 ? 'block' : 'none';
      submitQuizBtn.style.display = quizSubmitted ? 'none' : 'block';
    }

    if (prevQuestionBtn) {
      prevQuestionBtn.addEventListener('click', () => {
        if (currentQuestion > 0) {
          currentQuestion--;
          renderQuestion();
        }
      });
    }

    if (nextQuestionBtn) {
      nextQuestionBtn.addEventListener('click', () => {
        if (currentQuestion < quizData.length - 1) {
          currentQuestion++;
          renderQuestion();
        }
      });
    }

    if (submitQuizBtn) {
      submitQuizBtn.addEventListener('click', async () => {
        const unansweredCount = userAnswers.filter(a => a === null).length;
        if (unansweredCount > 0) {
          if (!await showConfirm(`You have ${unansweredCount} unanswered question(s). Are you sure you want to finish?`, 'Unanswered Questions')) {
            return;
          }
        }

        stopTimer();
        quizSubmitted = true;

        const totalTime = Math.floor((Date.now() - quizStartTime) / 1000);
        let correctCount = 0;

        quizData.forEach((q, idx) => {
          if (userAnswers[idx] === q.correct_answer) {
            correctCount++;
          }
        });

        const percentage = Math.round((correctCount / quizData.length) * 100);

        // --- START: New code to save quiz results to the database ---
        async function saveQuizResult() {
          const studentId = localStorage.getItem('currentUserId');
          const chapterId = localStorage.getItem('selectedChapterId');

          if (!studentId || !chapterId) {
            console.error("Cannot save quiz result: studentId or chapterId is missing from localStorage.");
            return;
          }

          // Re-format quiz data to match the backend's expected structure
          const quizPayloadForBackend = quizData.map(q => {
            return {
              question: q.question,
              options: q.options, // These are already clean strings without "A)"
              correct_answer: String.fromCharCode(65 + q.correct_answer), // Convert index (e.g., 0) back to letter ("A")
              explanation: q.explanation
            };
          });

          const payload = {
            student_id: parseInt(studentId),
            chapter_id: parseInt(chapterId),
            // The score is now calculated on the backend. These keys are removed.
            // score: percentage,
            // correct: correctCount,
            // total: quizData.length,
            quiz: quizPayloadForBackend,
            user_answers: userAnswers, // Send the array of user's answer indices
            total_time_seconds: totalTime
          };

          try {
            const response = await fetch('http://127.0.0.1:8000/save_quiz_result', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (response.ok) {
              const result = await response.json();
              console.log('Quiz result saved successfully:', result);
            } else {
              const errorData = await response.json();
              console.error('Failed to save quiz result:', errorData.detail);
            }
          } catch (error) {
            console.error('Error while trying to save quiz result:', error);
          }
        }

        saveQuizResult(); // Call the function to save the results in the background
        // --- END: New code ---

        quizNav.style.display = 'none'; // Hide nav on results screen

        quizContent.innerHTML = `
          <div class="quiz-result-card">
            <h2 style="margin-top:0;">üéâ Quiz Complete!</h2>
            <div class="quiz-result-score">${percentage}%</div>
            <div class="quiz-result-details">
              <div class="quiz-result-detail">
                <div class="quiz-result-detail-value" style="color:#22c55e;">${correctCount}</div>
                <div class="quiz-result-detail-label">Correct</div>
              </div>
              <div class="quiz-result-detail">
                <div class="quiz-result-detail-value" style="color:#ef4444;">${quizData.length - correctCount}</div>
                <div class="quiz-result-detail-label">Incorrect</div>
              </div>
              <div class="quiz-result-detail">
                <div class="quiz-result-detail-value" style="color:#fbbf24;">${formatTime(totalTime)}</div>
                <div class="quiz-result-detail-label">Time Taken</div>
              </div>
            </div>
            <div style="margin-top:30px;">
              <button class="quiz-btn quiz-btn-primary" id="reviewAnswersBtn">üìù Review Answers</button>
              <button class="quiz-btn quiz-btn-secondary" id="closeResultsBtn">Close</button>
            </div>
          </div>
        `;

        document.getElementById('reviewAnswersBtn').addEventListener('click', () => {
          currentQuestion = 0;
          quizNav.style.display = 'grid'; // Show nav for review
          renderQuestion();
        });

        document.getElementById('closeResultsBtn').addEventListener('click', () => {
          quizModal.classList.remove('active');
          quizData = [];
          userAnswers = [];
          currentQuestion = 0;
          quizSubmitted = false;
          quizNav.style.display = 'grid'; // Reset nav for next quiz
        });

        prevQuestionBtn.style.display = 'none';
        nextQuestionBtn.style.display = 'none';
        submitQuizBtn.style.display = 'none';
      });
    }

    // Initial load
    loadSummaries();
    loadFlashcards();
  </script>
</body>
</html>