<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BytLearn — Learn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --border: rgba(255,255,255,0.2);
      --glass: rgba(255,255,255,0.1);
      --text: #fff;
      --muted: rgba(255,255,255,0.85);
      --accent: #e5a054;
      --accent-glow: rgba(229, 160, 84, 0.3);
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial;
      color: var(--text);
      text-align: center;
    }
    body {
      background: linear-gradient(135deg, #7e22ce 0%, #f472b6 45%, #6366f1 100%);
      background-attachment: fixed;
      position: relative;
      overflow-x: hidden;
      font-size: 18px;
      text-align: center;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      pointer-events: none;
      z-index: 0;
    }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); }
    .container {
      position: relative; z-index: 1; max-width: 1200px; margin: 0 auto; padding: 32px;
      text-align: center;
    }
    main.container { min-height: calc(100vh - 110px); }
    .row {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      text-align: center;
    }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo img { width: 70px; height: 70px; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center;
      padding:12px 16px; border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.18);
      color: var(--text); text-decoration: none;
      transition:150ms;
      backdrop-filter: blur(6px);
    }
    .btn:hover { background: rgba(255,255,255,0.24); }
    .card {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 18px; 
      padding: 14px;
      backdrop-filter: blur(8px);
      text-align: center;
    }
    #summary.card {
      max-width: 100%;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
    }
    #summary .grid {
      max-width: 100%;
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      grid-template-columns: 1fr;
    }
    #summary .card {
      width: 100%;
      max-width: 100%;
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
    }
    .pills {
      display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px;
    }
    .pill {
      padding: 10px 16px; border-radius: 14px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.08); color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    .pill.active {
      background: rgba(255,255,255,0.2);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.12);
    }
    .hidden { display: none; }
    h2 { 
      margin: 0 0 12px;
      font-weight: 800;
      font-size: 28px;
      letter-spacing: -0.5px;
    }
    p { color: var(--muted); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media(min-width:768px) { .grid { grid-template-columns: 1fr 1fr; } }
    #flashcards .grid { 
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 300px;
      position: relative;
      overflow: visible;
    }
    
    .flashcard-container {
      position: relative;
      width: 100%;
      max-width: 1000px;
      height: 350px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.18);
      border: 1px solid var(--border);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 150ms;
      z-index: 20;
      font-size: 20px;
      color: var(--text);
      user-select: none;
    }

    .nav-arrow:hover {
      background: rgba(255,255,255,0.24);
    }

    .nav-arrow.left {
      left: 10px;
    }

    .nav-arrow.right {
      right: 10px;
    }

    .nav-arrow.disabled {
      opacity: 1;
      cursor: pointer;
    }
    
    .flashcard-scrollbar-wrapper {
      width: 100%;
      max-width: 1000px;
      margin-top: 20px;
      padding: 0 10px;
    }
    
    .flashcard-scrollbar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      position: relative;
      cursor: pointer;
      backdrop-filter: blur(6px);
      border: 1px solid var(--border);
    }
    
    .flashcard-scrollbar-thumb {
      height: 100%;
      background: rgba(255,255,255,0.4);
      border-radius: 4px;
      position: absolute;
      left: 0;
      transition: background 0.2s;
      cursor: grab;
    }
    
    .flashcard-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.5);
    }
    
    .flashcard-scrollbar-thumb:active {
      cursor: grabbing;
      background: rgba(255,255,255,0.6);
    }
    
    h2, h3, h1, p, .badge, .subtitle, .title, .lead, .actions, .stats, .pill, .item a, .list, .li {
      text-align: center !important;
    }
    .flashcard {
      transition: box-shadow 0.2s;
    }
    .flashcard:active, .flashcard:focus {
      box-shadow: 0 0 0 4px #a21caf;
    }
    .summary-text {
      white-space: pre-wrap;
      text-align: left;
      font-size: 16px;
      margin: 24px 40px;
      padding: 20px 32px;
      line-height: 1.8;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      letter-spacing: 0.01em;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      border-left: 4px solid var(--accent);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
    }

    .summary-text .heading {
      display: block !important;
      font-weight: 800 !important;
      color: var(--accent) !important;
      font-size: 22px !important;
      margin: 32px 0 16px 0 !important;
      padding-bottom: 12px !important;
      border-bottom: 3px solid var(--accent) !important;
      text-align: left !important;
      font-family: 'Playfair Display', 'Inter', serif !important;
      letter-spacing: -0.02em !important;
      width: 100%;
      text-shadow: 0 2px 8px var(--accent-glow);
      position: relative;
    }

    .summary-text .heading::before {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #fff 0%, var(--accent) 100%);
      box-shadow: 0 0 10px var(--accent-glow);
    }

    .summary-text .heading:first-child {
      margin-top: 0 !important;
    }

    .summary-text p {
      margin: 12px 0;
      text-align: left;
      color: rgba(255,255,255,0.95);
      font-weight: 500;
    }

    .summary-text strong {
      color: #fff;
      font-weight: 700;
    }
    
    .flashcard-text {
      white-space: pre-wrap;
      font-family: "Times New Roman", Times, serif;
      text-align: justify;
      font-size: 19px;
      margin: 16px 30px;
      padding: 0 0 0 2px;
    }

    .card-item {
      position: absolute;
      width: 480px;
      height: 350px;
      border-radius: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: var(--glass);
      border: 1px solid var(--border);
      backdrop-filter: blur(8px);
      transition: transform 0.4s ease, opacity 0.4s ease, left 0.4s ease;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      user-select: none;
    }
    
    .card-item.visited {
      left: -120px;
      transform: scale(0.75);
      opacity: 0.5;
      z-index: 5;
    }
    
    .card-item.visited:nth-child(1) {
      left: -120px;
      z-index: 5;
    }
    
    .card-item.visited:nth-child(2) {
      left: -100px;
      z-index: 6;
    }
    
    .card-item.visited:nth-child(3) {
      left: -80px;
      z-index: 7;
    }
    
    .card-item.current {
      left: 50%;
      transform: translateX(-50%) scale(1);
      opacity: 1;
      z-index: 10;
    }
    
    .card-item.unvisited {
      left: auto;
      right: -120px;
      transform: scale(0.75);
      opacity: 0.5;
      z-index: 5;
    }
    
    .card-item.unvisited:nth-last-child(1) {
      right: -120px;
      z-index: 5;
    }
    
    .card-item.unvisited:nth-last-child(2) {
      right: -100px;
      z-index: 6;
    }
    
    .card-item.unvisited:nth-last-child(3) {
      right: -80px;
      z-index: 7;
    }

    .card-front {
      background: linear-gradient(135deg, rgba(162, 28, 175, 0.4) 0%, rgba(109, 40, 217, 0.4) 100%);
    }

    .card-back {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.25) 0%, rgba(245, 158, 11, 0.25) 100%);
    }

    .flashcard-title {
      font-size: 20px;
      font-weight: 800;
      color: #ffffff;
      margin-bottom: 16px;
      text-align: center;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      letter-spacing: 0.3px;
    }

    .flashcard-content {
      font-size: 17px;
      line-height: 1.8;
      text-align: justify;
      text-align-last: center;
      color: #ffffff;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow-y: auto;
      max-height: 100%;
      font-weight: 600;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
      letter-spacing: 0.3px;
      word-spacing: 0.5px;
      padding: 0 8px;
      hyphens: auto;
    }

    .flashcard-prompt {
      font-size: 22px;
      font-weight: 800;
      color: #ffffff;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      letter-spacing: 0.5px;
    }

    .flashcard > div[style*="font-weight:600"] {
      display: none;
    }

    /* Enhanced section headers */
    .tab > .row {
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.15);
    }

    /* Loading state styling */
    .loading-text {
      color: var(--muted);
      margin: 24px 0;
      font-weight: 500;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    /* Error message styling */
    .error-message {
      color: #fca5a5;
      font-weight: 500;
      margin: 24px 0;
      font-size: 16px;
      letter-spacing: 0.01em;
      opacity: 0.95;
    }

    .error-message::before {
      content: "⚠ ";
      margin-right: 6px;
      opacity: 0.9;
    }
    .summary-text::-webkit-scrollbar {
      width: 8px;
    }

    .summary-text::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }

    .summary-text::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }

    .summary-text::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.3);
    }
  </style>
</head>
<body>
  <div class="overlay"></div>
  <header class="container">
    <div class="row">
      <div class="logo" style="cursor:pointer;" onclick="location.href='./welcome.html'">
        <img src="./logo.png" alt="BytLearn" />
        <div>
          <div style="font-weight:800;font-size:22px;">BytLearn</div>
          <div style="font-size:12px;opacity:.8">Learning Workspace — <span id="lName">Student</span></div>
        </div>
      </div>
      <div class="row" style="gap:10px;">
        <a class="btn" href="./dashboard.html">Dashboard</a>
        <a class="btn" href="./profile.html" title="Profile">Profile</a>
        <a class="btn" href="./welcome.html"
           onclick="event.preventDefault(); localStorage.removeItem('authed'); location.href='./welcome.html';">
          Sign Out
        </a>
      </div>
    </div>
  </header>
  <main class="container">
    <div class="card" style="margin-bottom:12px;">
      <div class="pills">
        <button class="pill active" data-tab="summary">Summaries</button>
        <button class="pill" data-tab="flashcards">Flashcards</button>
        <button class="pill" data-tab="doubts">Doubt Asking</button>
        <button class="pill" data-tab="quizzes">Quizzes</button>
      </div>
    </div>
    <section id="summary" class="card tab">
      <div class="row" style="justify-content:space-between;">
        <h2>Chapter Summary</h2>
        <span class="pill" style="cursor:default;">Summary</span>
      </div>
      <p></p>
      <div class="grid" style="margin-top:10px">
      </div>
    </section>
    <section id="flashcards" class="card tab hidden">
      <div class="row" style="justify-content:space-between;">
        <h2>Flashcards</h2>
        <span class="pill" style="cursor:default;">Recall</span>
      </div>
      <div class="grid" style="margin-top:10px"></div>
    </section>
    <section id="doubts" class="card tab hidden">
      <div class="row" style="justify-content:space-between;">
        <h2>Ask a Doubt</h2>
        <span class="pill" style="cursor:default;">?</span>
      </div>
        <div id="chat-history" style="height:260px;overflow-y:auto;background:rgba(255,255,255,0.08);border-radius:12px;padding:12px 8px 12px 8px;margin-bottom:12px;text-align:left;font-size:16px;box-shadow:inset 0 0 0 1px rgba(0,0,0,0.06);">
          <div style="color:var(--muted);text-align:center;">Choose a topic from your notes and ask question's about it.</div>
        </div>
        <form id="chat-form" style="display:flex;gap:8px;align-items:center;" autocomplete="off" onsubmit="return false;">
          <input id="chat-input" type="text" placeholder="Type your doubt..." style="flex:1;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,0.13);color:var(--text);font-size:16px;outline:none;" />
          <button type="submit" class="btn" style="padding:10px 18px;font-size:16px;">Send</button>
        </form>
    </section>
    <section id="quizzes" class="card tab hidden">
      <div class="row" style="justify-content:space-between;">
        <h2>Quick Quiz</h2>
        <span class="pill" style="cursor:default;">Practice</span>
      </div>
      <p>Test yourself with quick objective questions and instant feedback.</p>
        <div id="quiz-controls" style="margin:18px 0;">
          <button id="generate-quiz-btn" class="btn" style="font-size:16px;padding:10px 22px;">Generate Quiz</button>
        </div>
        <div id="quiz-area"></div>
    </section>
  </main>
  <script>
    const quizArea = document.getElementById('quiz-area');
    const quizControls = document.getElementById('quiz-controls');
    const generateQuizBtn = document.getElementById('generate-quiz-btn');
    let quizData = null;

    if (generateQuizBtn) {
      generateQuizBtn.addEventListener('click', async function() {
        quizArea.innerHTML = '<div class="loading-text">Generating quiz...</div>';
        generateQuizBtn.disabled = true;
        try {
          const res = await fetch('/generate_quiz', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topic: 'current' })
          });
          const data = await res.json();
          if (data && Array.isArray(data.questions) && data.questions.length > 0) {
            quizData = data.questions;
            renderQuiz(quizData);
          } else {
            quizArea.innerHTML = '<div class="error-message">No quiz questions generated.</div>';
            generateQuizBtn.disabled = false;
          }
        } catch (e) {
          quizArea.innerHTML = '<div class="error-message">Error generating quiz: ' + (e.message || e) + '</div>';
          generateQuizBtn.disabled = false;
        }
      });
    }

    function renderQuiz(questions) {
      if (!questions || !questions.length) {
        quizArea.innerHTML = '<div class="error-message">No quiz questions available.</div>';
        return;
      }
      let html = '<form id="quiz-form-area">';
      questions.forEach((q, idx) => {
        html += `<div class="card" style="margin-bottom:18px;text-align:left;">
          <div style="font-weight:600;margin-bottom:8px;">Q${idx+1}. ${q.question || ''}</div>
          <ul style="opacity:.85;line-height:1.8;list-style-type:upper-alpha;">
            ${q.options.map((opt, oidx) => `
              <li style="margin-bottom:6px;">
                <label style="cursor:pointer;">
                  <input type="radio" name="q${idx}" value="${oidx}" style="margin-right:8px;" />
                  ${opt}
                </label>
              </li>
            `).join('')}
          </ul>
        </div>`;
      });
      html += '<button type="submit" class="btn" style="font-size:16px;padding:10px 22px;">Submit Quiz</button>';
      html += '</form>';
      quizArea.innerHTML = html;

      const quizForm = document.getElementById('quiz-form-area');
      if (quizForm) {
        quizForm.addEventListener('submit', function(e) {
          e.preventDefault();
          if (!quizData || !quizData.length) return;
          let correct = 0;
          let total = quizData.length;
          quizData.forEach((q, idx) => {
            const selected = quizForm.querySelector(`input[name='q${idx}']:checked`);
            if (selected && q.answer !== undefined && Number(selected.value) === q.answer) correct++;
          });
          quizArea.innerHTML += `<div style='margin:18px 0;font-size:18px;font-weight:600;'>You got ${correct} out of ${total} correct.</div>`;
        });
      }
      generateQuizBtn.disabled = false;
    }

    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatHistory = document.getElementById('chat-history');

    if (chatForm && chatInput && chatHistory) {
      chatForm.addEventListener('submit', async function() {
        const userMsg = chatInput.value.trim();
        if (!userMsg) return;
        addMsg('You', userMsg, 'right');
        chatInput.value = '';
        chatInput.disabled = true;
        const loadingId = addMsg('Bot', '<span style="opacity:.7;">Thinking...</span>', 'left', true);
        try {
          const res = await fetch('http://127.0.0.1:8000/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: userMsg })
          });
          const data = await res.json();
          removeMsg(loadingId);
          if (data.answer) {
            addMsg('Bot', data.answer, 'left');
          } else if (data.error) {
            addMsg('Bot', `<span style='color:#fca5a5;font-weight:500;'>⚠ ${data.error}</span>`, 'left');
          } else {
            addMsg('Bot', '<span style="color:#fca5a5;font-weight:500;">⚠ No answer received.</span>', 'left');
          }
        } catch (e) {
          removeMsg(loadingId);
          addMsg('Bot', `<span style='color:#fca5a5;font-weight:500;'>⚠ Error: ${e.message}</span>`, 'left');
        }
        chatInput.disabled = false;
        chatInput.focus();
      });
      function addMsg(sender, text, align, isLoading) {
        const msg = document.createElement('div');
        msg.className = 'chat-msg';
        msg.style = `margin:8px 0;display:flex;justify-content:${align==='right'?'flex-end':'flex-start'};`;
        msg.innerHTML = `<div style="max-width:80%;background:${align==='right'?'#a21caf':'rgba(255,255,255,0.13)'};color:${align==='right'?'#fff':'var(--text)'};padding:10px 14px;border-radius:12px;font-size:16px;box-shadow:0 1px 4px 0 rgba(0,0,0,0.07);">${text}</div>`;
        chatHistory.appendChild(msg);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        if (isLoading) {
          const id = 'loading-' + Math.random().toString(36).slice(2);
          msg.id = id;
          return id;
        }
        return null;
      }
      function removeMsg(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
      }
    }

    if (localStorage.getItem('authed') !== '1') {
      location.replace('./login.html');
    }

    const pills = document.querySelectorAll(".pill[data-tab]");
    const tabs = document.querySelectorAll(".tab");
    pills.forEach(p => p.addEventListener("click", () => {
      pills.forEach(pp => pp.classList.remove("active"));
      p.classList.add("active");
      const id = p.getAttribute("data-tab");
      tabs.forEach(t => t.classList.add("hidden"));
      document.getElementById(id)?.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }));

    (function(){
      const n = localStorage.getItem("currentUserName") || "Student";
      const el = document.getElementById("lName");
      if (el) el.textContent = n;
    })();

    async function loadSummaries() {
      const grid = document.querySelector("#summary .grid");
      if (!grid) return;
      grid.innerHTML = '<div class="loading-text">Loading summaries...</div>';

      const chapterId = Number(localStorage.getItem("selectedChapterId"));
      if (!chapterId) {
        grid.innerHTML = '<div class="error-message">No chapter selected. Go to Dashboard and pick a chapter.</div>';
        return;
      }

      try {
        const res = await fetch("http://127.0.0.1:8000/summaries");
        const summaries = await res.json();
        const filtered = summaries.filter((s) => s.chapter_id === chapterId);

        if (filtered.length > 0) {
          grid.innerHTML = "";
          filtered.forEach((summary) => {
            let text = summary.summary_data;
            
            const lines = text.split('\n');
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();
              
              if (line.startsWith('Section:') || line.startsWith('Section ')) {
                lines[i] = '<span class="heading">' + lines[i] + '</span>';
              }
              else if (/^\d+\.\d+\s/.test(line)) {
                lines[i] = '<span class="heading">' + lines[i] + '</span>';
              }
              else if (line === 'Key Terms' || line === 'Chapter Summary' || line === 'High-Yield Exam Facts') {
                lines[i] = '<span class="heading">' + lines[i] + '</span>';
              }
            }
            text = lines.join('\n');
            
            grid.innerHTML += `<div class="summary-text">${text}</div>`;
          });
        } else {
          grid.innerHTML = '<div class="error-message">No summaries found for this chapter.</div>';
        }
      } catch (e) {
        grid.innerHTML = `<div class="error-message">Error loading summaries: ${e.message}</div>`;
      }
    }

    async function loadFlashcards() {
      const grid = document.querySelector("#flashcards .grid");
      if (!grid) return;
      grid.innerHTML = '<div class="loading-text">Loading flashcards...</div>';

      const chapterId = Number(localStorage.getItem("selectedChapterId"));
      if (!chapterId) {
        grid.innerHTML = '<div class="error-message">No chapter selected. Go to Dashboard and pick a chapter.</div>';
        return;
      }

      try {
        const res = await fetch("http://127.0.0.1:8000/flashcards");
        const flashcards = await res.json();
        const filtered = flashcards.filter((f) => f.chapter_id === chapterId);

        if (filtered.length > 0) {
          grid.innerHTML = `
            <div class="nav-arrow left" id="prev-card">←</div>
            <div class="flashcard-container" id="card-container"></div>
            <div class="nav-arrow right" id="next-card">→</div>
            <div class="flashcard-scrollbar-wrapper">
              <div class="flashcard-scrollbar" id="flashcard-scrollbar">
                <div class="flashcard-scrollbar-thumb" id="flashcard-scrollbar-thumb"></div>
              </div>
            </div>
          `;
          
          const container = document.getElementById('card-container');
          const prevBtn = document.getElementById('prev-card');
          const nextBtn = document.getElementById('next-card');
          const scrollbar = document.getElementById('flashcard-scrollbar');
          const scrollbarThumb = document.getElementById('flashcard-scrollbar-thumb');
          let currentCardIndex = 0;
          let isFlipped = false;
          
          const allCards = filtered.map((flashcard, idx) => {
            const raw = (flashcard.flashcard_data || '').replace(/\r/g, '');
            let topic = '', keypoint = '';
            
            if (/Key Point:/i.test(raw)) {
              const parts = raw.split(/Key Point:/i);
              topic = parts[0].trim();
              keypoint = parts.slice(1).join('Key Point:').trim();
            } else if (raw.includes('|')) {
              const parts = raw.split('|');
              topic = parts[0].trim().replace(/\|+$/, "");
              keypoint = parts.slice(1).join(' ').trim();
            } else {
              const lines = raw.split('\n').map(s=>s.trim()).filter(Boolean);
              topic = lines.shift() || '';
              keypoint = lines.join(' ') || '';
            }

            topic = topic.replace(/\|/g, '').replace(/\[\d+\]/g, '').trim();
            keypoint = keypoint.replace(/\|/g, '').replace(/\[\d+\]/g, '').trim();
            
            return { topic, keypoint };
          });
          
          function createCard(index, cardData) {
            const cardEl = document.createElement('div');
            cardEl.className = 'card-item card-front';
            cardEl.dataset.index = index;
            cardEl.innerHTML = `<div class="flashcard-prompt">Tap to reveal (${index + 1}/${allCards.length})</div>`;
            
            cardEl.addEventListener('click', function() {
              if (parseInt(cardEl.dataset.index) !== currentCardIndex) return;
              
              if (!isFlipped) {
                cardEl.classList.remove('card-front');
                cardEl.classList.add('card-back');
                cardEl.innerHTML = `
                  <div class="flashcard-title">${cardData.topic}</div>
                  <div class="flashcard-content">${cardData.keypoint}</div>
                `;
                isFlipped = true;
              } else {
                cardEl.classList.remove('card-back');
                cardEl.classList.add('card-front');
                cardEl.innerHTML = `<div class="flashcard-prompt">Tap to reveal (${index + 1}/${allCards.length})</div>`;
                isFlipped = false;
              }
            });
            
            return cardEl;
          }
          
          function updateScrollbar() {
            const thumbWidth = (1 / allCards.length) * 100;
            const thumbPosition = (currentCardIndex / allCards.length) * 100;
            scrollbarThumb.style.width = thumbWidth + '%';
            scrollbarThumb.style.left = thumbPosition + '%';
          }
          
          function updateCardPositions() {
            const cards = Array.from(container.children);
            
            cards.forEach((card, idx) => {
              card.classList.remove('visited', 'current', 'unvisited');
              
              if (idx < currentCardIndex) {
                card.classList.add('visited');
              } else if (idx === currentCardIndex) {
                card.classList.add('current');
              } else {
                card.classList.add('unvisited');
              }
            });
            
            prevBtn.classList.toggle('disabled', currentCardIndex === 0);
            nextBtn.classList.toggle('disabled', currentCardIndex === allCards.length - 1);
            updateScrollbar();
          }
          
          function goToNext() {
            if (currentCardIndex > 0) {
              currentCardIndex--;
              isFlipped = false;
              updateCardPositions();
            }
          }
          
          function goToPrev() {
            if (currentCardIndex < allCards.length - 1) {
              currentCardIndex++;
              isFlipped = false;
              updateCardPositions();
            }
          }
          
          prevBtn.addEventListener('click', goToPrev);
          nextBtn.addEventListener('click', goToNext);
          
          scrollbar.addEventListener('click', function(e) {
            if (e.target === scrollbarThumb) return;
            const rect = scrollbar.getBoundingClientRect();
            const clickPosition = (e.clientX - rect.left) / rect.width;
            currentCardIndex = Math.round(clickPosition * (allCards.length - 1));
            isFlipped = false;
            updateCardPositions();
          });
          
          let isDragging = false;
          let startX = 0;
          let startIndex = 0;
          
          scrollbarThumb.addEventListener('mousedown', function(e) {
            isDragging = true;
            startX = e.clientX;
            startIndex = currentCardIndex;
            e.preventDefault();
          });
          
          document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            const rect = scrollbar.getBoundingClientRect();
            const deltaX = e.clientX - startX;
            const deltaIndex = Math.round((deltaX / rect.width) * allCards.length);
            const newIndex = Math.max(0, Math.min(allCards.length - 1, startIndex + deltaIndex));
            if (newIndex !== currentCardIndex) {
              currentCardIndex = newIndex;
              isFlipped = false;
              updateCardPositions();
            }
          });
          
          document.addEventListener('mouseup', function() {
            isDragging = false;
          });
          
          allCards.forEach((cardData, idx) => {
            const card = createCard(idx, cardData);
            container.appendChild(card);
          });
          
          updateCardPositions();
          
          container.addEventListener('wheel', function(e) {
            const threshold = 30;
            if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
              if (Math.abs(e.deltaX) > threshold) {
                if (e.deltaX > 0 && currentCardIndex < allCards.length - 1) {
                  currentCardIndex++;
                  isFlipped = false;
                  updateCardPositions();
                  e.preventDefault();
                } else if (e.deltaX < 0 && currentCardIndex > 0) {
                  currentCardIndex--;
                  isFlipped = false;
                  updateCardPositions();
                  e.preventDefault();
                }
              }
            } else if (Math.abs(e.deltaY) > threshold) {
              if (e.deltaY > 0 && currentCardIndex < allCards.length - 1) {
                currentCardIndex++;
                isFlipped = false;
                updateCardPositions();
                e.preventDefault();
              } else if (e.deltaY < 0 && currentCardIndex > 0) {
                currentCardIndex--;
                isFlipped = false;
                updateCardPositions();
                e.preventDefault();
              }
            }
          }, { passive: false });
        } else {
          grid.innerHTML = '<div class="error-message">No flashcards found for this chapter.</div>';
        }
      } catch (e) {
        grid.innerHTML = `<div class="error-message">Error loading flashcards: ${e.message}</div>`;
      }
    }

    loadSummaries();
    loadFlashcards();
  </script>
</body>
</html>